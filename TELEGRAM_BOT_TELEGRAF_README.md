# Модуль Telegram бота с nestjs-telegraf

Этот модуль обеспечивает простую интеграцию с Telegram ботом используя библиотеку `nestjs-telegraf` для обработки сообщений и авторизации пользователей.

## Функциональность

### 1. Обработка команд бота

- Команда `/start` с токеном авторизации
- Команда `/start` без токена (приветственное сообщение)
- Обработка обычных текстовых сообщений

### 2. Авторизация пользователей

- Генерация токенов авторизации
- Создание ссылок вида `t.me/omnicore_bot?start=TOKEN`
- Автоматическое связывание Telegram аккаунта с пользователем системы

### 3. Персонализированные сообщения

- Отправка сообщений конкретному пользователю через его Telegram
- Интеграция с системой социальных сетей
- Автоматическое определение chat_id пользователя

## Настройка

### Переменные окружения

Добавьте в ваш `.env` файл:

```env
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_BOT_USERNAME=omnicore_bot
```

### Создание бота

1. Найдите [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Получите токен бота и добавьте его в переменные окружения

## API Endpoints

### Управление токенами авторизации

#### Создать токен авторизации

```
POST /telegram-bot/auth-token
Authorization: Bearer <JWT_TOKEN>
```

Ответ:

```json
{
  "token": "abc123def456...",
  "authLink": "https://t.me/omnicore_bot?start=abc123def456...",
  "message": "Токен авторизации создан. Отправьте ссылку пользователю для авторизации в Telegram."
}
```

### Отправка сообщений

#### Отправить персонализированное сообщение

```
POST /telegram-bot/send-message
Authorization: Bearer <JWT_TOKEN>
```

Тело запроса:

```json
{
  "message": "Ваше персонализированное сообщение"
}
```

#### Отправить тестовое сообщение

```
POST /telegram-bot/test-message
Authorization: Bearer <JWT_TOKEN>
```

Тело запроса:

```json
{
  "chatId": "-1001234567890",
  "message": "Тестовое сообщение"
}
```

### Информация о боте

#### Получить информацию о боте

```
GET /telegram-bot/bot-info
```

#### Проверить статус авторизации пользователя

```
GET /telegram-bot/auth-status
Authorization: Bearer <JWT_TOKEN>
```

Ответ:

```json
{
  "isAuthorized": true,
  "chatId": "-1001234567890",
  "message": "Пользователь авторизован в Telegram"
}
```

## Процесс авторизации

### 1. Создание токена

Пользователь создает токен авторизации через API:

```javascript
const response = await fetch('/telegram-bot/auth-token', {
  method: 'POST',
  headers: {
    Authorization: 'Bearer ' + jwtToken,
    'Content-Type': 'application/json',
  },
});

const { authLink } = await response.json();
```

### 2. Отправка ссылки пользователю

Покажите пользователю ссылку для авторизации:

```html
<a href="https://t.me/omnicore_bot?start=abc123def456..." target="_blank">
  Авторизоваться в Telegram
</a>
```

### 3. Авторизация в боте

Пользователь переходит по ссылке и отправляет команду `/start` боту. Бот автоматически:

- Проверяет токен
- Связывает Telegram аккаунт с пользователем системы
- Сохраняет chat_id для будущих сообщений
- Отправляет подтверждение об успешной авторизации

### 4. Отправка персонализированных сообщений

После авторизации можно отправлять сообщения:

```javascript
// Через Telegram бот модуль
await fetch('/telegram-bot/send-message', {
  method: 'POST',
  headers: { Authorization: 'Bearer ' + jwtToken },
  body: JSON.stringify({ message: 'Привет! У вас новое сообщение в системе.' }),
});

// Через социальный модуль
await fetch('/social/send-personalized', {
  method: 'POST',
  headers: { Authorization: 'Bearer ' + jwtToken },
  body: JSON.stringify({ message: 'Персонализированное сообщение' }),
});
```

## Команды бота

### `/start`

- Без параметров: приветственное сообщение
- С токеном: авторизация пользователя

### Обычные сообщения

- Любой текст: инструкции по авторизации

## Структура модуля

### TelegramBotModule

- Основной модуль NestJS
- Настройка TelegrafModule
- Регистрация контроллеров и сервисов

### TelegramBotService

- Бизнес-логика обработки сообщений
- Управление токенами авторизации
- Интеграция с базой данных

### TelegramBotController

- Обработка команд бота
- Настройка обработчиков событий
- Управление жизненным циклом бота

### TelegramBotApiController

- REST API для управления ботом
- Создание токенов авторизации
- Отправка персонализированных сообщений

## Интеграция с социальными сетями

Модуль автоматически интегрируется с модулем социальных сетей:

1. При авторизации создается запись в таблице `user_social_settings`
2. Платформа автоматически устанавливается как `telegram`
3. `chatId` сохраняется для будущих сообщений
4. `isEnabled` устанавливается в `true`

## Обработка ошибок

### Типичные ошибки и их решения

#### "Пользователь не авторизован в Telegram"

- Пользователь не прошел авторизацию через бота
- Отправьте ему ссылку для авторизации

#### "Ошибка отправки сообщения"

- Пользователь заблокировал бота
- Неверный chat_id
- Проблемы с сетью

## Безопасность

- Все API endpoints защищены JWT авторизацией
- Токены авторизации генерируются криптографически стойким способом
- Обработка ошибок не раскрывает внутреннюю логику

## Мониторинг

Для мониторинга работы бота можно использовать:

1. Логи приложения для отслеживания ошибок
2. Таблицу `user_social_settings` для статистики авторизаций
3. Таблицу `user_social_messages` для отслеживания отправленных сообщений

## Преимущества использования nestjs-telegraf

- **Простота**: Минимальная настройка, автоматическая обработка сообщений
- **Типизация**: Полная поддержка TypeScript
- **Интеграция**: Легкая интеграция с NestJS экосистемой
- **Polling**: Использует polling вместо webhook для простоты развертывания
- **Обработка ошибок**: Встроенная обработка ошибок и исключений

## Расширение функциональности

Модуль легко расширяется для добавления новых возможностей:

- Inline кнопки для интерактивности
- Команды бота (`/help`, `/status`, `/settings`)
- Уведомления о статусе системы
- Интеграция с другими мессенджерами
- Webhook вместо polling для production
