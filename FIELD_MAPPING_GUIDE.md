# Руководство по маппингу полей в шаблонах сообщений

## Обзор

Система маппинга полей позволяет сопоставлять поля из webhook с переменными в шаблонах сообщений. Это обеспечивает гибкость в создании персонализированных сообщений.

## Как работает система

### 1. Структура данных

#### FieldGroupEntity

```typescript
{
  id: string;              // UUID группы полей
  user_id: string;         // ID пользователя
  title: string;           // Название группы (например, "Контактная форма")
  fieldGroup: {            // JSONB поле с данными о полях
    id: string;
    title: string;
    fields: [
      {
        id: string;        // Используется как имя переменной в шаблоне
        fieldName: string; // Имя поля в webhook данных
      }
    ]
  }
}
```

### 2. Процесс замены переменных

Когда приходит webhook сообщение, система выполняет следующие шаги:

1. **Базовые переменные** - добавляются автоматически:

   - `{{siteName}}` - имя сайта
   - `{{formName}}` - имя формы
   - `{{time}}` - время получения
   - `{{date}}` - дата получения

2. **Прямые поля из webhook** - все поля добавляются как есть:

   - `{{your-name}}` → значение из `webhookData.data['your-name']`
   - `{{your-email}}` → значение из `webhookData.data['your-email']`
   - и т.д.

3. **Маппинги из групп полей** - пользовательские настройки:

   - Система ищет группы полей пользователя в `field_groups`
   - Для каждого поля в группе:
     - `field.fieldName` - имя поля в webhook данных (например, "your-name")
     - `field.id` - имя переменной в шаблоне (например, "name")
   - Создается маппинг: `{{name}}` → значение из `webhookData.data['your-name']`

4. **Рекламные параметры** - UTM метки:
   - `{{utm_source}}`, `{{utm_campaign}}` и т.д.

### 3. Пример использования

#### Webhook данные

```json
{
  "siteName": "mysite.com",
  "formName": "Контактная форма",
  "data": {
    "your-name": "Иван",
    "your-email": "ivan@example.com",
    "textarea-294": "Мое пожелание"
  }
}
```

#### Группа полей пользователя

```json
{
  "title": "Контактная форма",
  "fieldGroup": {
    "fields": [
      {
        "id": "name", // Переменная в шаблоне: {{name}}
        "fieldName": "your-name" // Поле в webhook: your-name
      },
      {
        "id": "email",
        "fieldName": "your-email"
      },
      {
        "id": "пожелание",
        "fieldName": "textarea-294"
      }
    ]
  }
}
```

#### Шаблон сообщения

```
Привет, {{name}}!
Email: {{email}}
Пожелание: {{пожелание}}
```

#### Результат

```
Привет, Иван!
Email: ivan@example.com
Пожелание: Мое пожелание
```

## API для работы с группами полей

### Создание группы полей

```typescript
POST /field-groups/create
{
  "title": "Контактная форма",
  "fields": [
    {
      "id": "name",
      "fieldName": "your-name"
    },
    {
      "id": "email",
      "fieldName": "your-email"
    }
  ]
}
```

### Получение всех групп полей

```typescript
GET / field - groups / all - templates;
```

Возвращает:

```json
{
  "fieldGroups": [...],  // Все группы полей пользователя
  "availableFields": [...] // Доступные поля из последних webhook
}
```

## Отладка

Система логирует процесс маппинга в DEBUG режиме:

```
[MessageTemplateService] Обработка N групп полей: {...}
[MessageTemplateService] Группа полей "...": N полей
[MessageTemplateService] Поле: webhookField="...", displayName="...", value="..."
[MessageTemplateService] ✓ Добавлен маппинг: {{...}} = "..." (из webhook поля "...")
[MessageTemplateService] Исходный шаблон: ...
[MessageTemplateService] Обработанный шаблон: ...
[MessageTemplateService] Доступные переменные: {...}
```

## Важные замечания

1. **Приоритет переменных**: Если переменная определена в нескольких местах, последнее определение перезаписывает предыдущие.

2. **Пустые значения**: Если поле не найдено в webhook данных, переменная не будет создана, и `{{переменная}}` останется в тексте как есть.

3. **Вложенные объекты**: Система поддерживает поиск в вложенных объектах через точечную нотацию:

   ```typescript
   fieldName: 'user_info.user_email'; // Доступ к webhookData.data.user_info.user_email
   ```

4. **Кириллица**: Переменные могут использовать кириллицу: `{{имя}}`, `{{пожелание}}` и т.д.

## Миграция со старой системы

Старая система использовала `FieldMapping[]` в метаданных шаблона. Новая система использует `FieldGroupEntity[]`, что позволяет:

- Переиспользовать группы полей между шаблонами
- Централизованно управлять маппингами
- Легко обновлять маппинги для всех шаблонов сразу
